generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                           String    @id @default(uuid())
  email                        String    @unique
  passwordHash                 String
  role                         UserRole  @default(VAULT_OWNER)

  // Profile fields
  firstName                    String?
  lastName                     String?
  avatarUrl                    String?

  // Onboarding
  onboardingCompletedAt        DateTime?

  // Security & verification
  totpSecret                   String?
  emailVerified                Boolean   @default(false)
  emailVerificationToken       String?   @unique
  emailVerificationTokenExpiry DateTime?

  // GDPR consent tracking
  termsAcceptedAt              DateTime?
  privacyPolicyAcceptedAt      DateTime?
  termsVersion                 String?   // Track which version was accepted

  createdAt                    DateTime  @default(now())
  updatedAt                    DateTime  @updatedAt
  deletedAt                    DateTime?

  vault              Vault?
  trustedContacts    TrustedContact[]
  beneficiaryProfile BeneficiaryProfile?

  @@index([deletedAt])
  @@index([emailVerificationToken])
  @@index([role])
}

enum UserRole {
  VAULT_OWNER
  BENEFICIARY
  BOTH
}

model Vault {
  id             String      @id @default(uuid())
  userId         String      @unique
  user           User        @relation(fields: [userId], references: [id])
  status         VaultStatus @default(active)
  encryptionSalt String
  unsealedAt     DateTime?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  keepsakes          Keepsake[]
  beneficiaries      Beneficiary[]
  deathDeclarations  DeathDeclaration[]
  notificationConfig NotificationConfig?
}

enum VaultStatus {
  active
  pending_verification
  unsealed
}

model Keepsake {
  id               String           @id @default(uuid())
  vaultId          String
  vault            Vault            @relation(fields: [vaultId], references: [id])
  type             KeepsakeType
  title            String
  encryptedContent String
  contentIV        String
  status           KeepsakeStatus   @default(draft)
  triggerCondition TriggerCondition @default(on_death)
  revealDelay      Int?
  revealDate       DateTime?
  scheduledAt      DateTime?
  deliveredAt      DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  deletedAt        DateTime?

  assignments  KeepsakeAssignment[]
  media        KeepsakeMedia[]
  invitations  BeneficiaryInvitation[]
  portalAccess BeneficiaryPortalAccess[]
  notifications NotificationLog[]

  @@index([vaultId])
  @@index([status])
  @@index([deletedAt])
}

enum KeepsakeType {
  document
  letter
  photo
  video
  wish
  scheduled_action
}

enum KeepsakeStatus {
  draft
  scheduled
  delivered
}

enum TriggerCondition {
  on_death
  on_date
  manual
}

model KeepsakeMedia {
  id         String    @id @default(uuid())
  keepsakeId String
  keepsake   Keepsake  @relation(fields: [keepsakeId], references: [id], onDelete: Cascade)
  type       MediaType
  key        String    @unique
  filename   String
  mimeType   String
  size       Int
  order      Int       @default(0)
  createdAt  DateTime  @default(now())

  @@index([keepsakeId])
}

enum MediaType {
  image
  video
  document
}

model Beneficiary {
  id           String       @id @default(uuid())
  vaultId      String
  vault        Vault        @relation(fields: [vaultId], references: [id], onDelete: Cascade)
  firstName    String
  lastName     String
  email        String
  relationship Relationship
  note         String?

  // Account linkage
  beneficiaryProfileId String?
  beneficiaryProfile   BeneficiaryProfile? @relation(fields: [beneficiaryProfileId], references: [id])
  isTrustedPerson      Boolean             @default(false)

  // Invitation tracking
  invitationToken      String?   @unique
  invitationSentAt     DateTime?
  invitationAcceptedAt DateTime?

  // Legacy fields (deprecated but kept for backward compatibility)
  accessToken String? @unique
  accessedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  assignments       KeepsakeAssignment[]
  invitations       BeneficiaryInvitation[]
  portalAccess      BeneficiaryPortalAccess[]
  notifications     NotificationLog[]
  deathDeclarations DeathDeclaration[]

  @@unique([vaultId, email])
  @@index([vaultId])
  @@index([email])
  @@index([invitationToken])
  @@index([beneficiaryProfileId])
}

enum Relationship {
  SPOUSE
  CHILD
  PARENT
  SIBLING
  GRANDCHILD
  GRANDPARENT
  FRIEND
  COLLEAGUE
  OTHER
}

model KeepsakeAssignment {
  id              String      @id @default(uuid())
  keepsakeId      String
  keepsake        Keepsake    @relation(fields: [keepsakeId], references: [id], onDelete: Cascade)
  beneficiaryId   String
  beneficiary     Beneficiary @relation(fields: [beneficiaryId], references: [id], onDelete: Cascade)
  personalMessage String?
  createdAt       DateTime    @default(now())

  @@unique([keepsakeId, beneficiaryId])
}

model TrustedContact {
  id               String   @id @default(uuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id])
  name             String
  email            String
  verificationCode String   @unique
  createdAt        DateTime @default(now())

  declarations DeathDeclaration[]

  @@unique([userId, email])
  @@index([userId])
}

model DeathDeclaration {
  id               String          @id @default(uuid())
  vaultId          String          @unique
  vault            Vault           @relation(fields: [vaultId], references: [id])
  // Declared by a beneficiary who is a trusted person
  declaredById     String
  declaredBy       Beneficiary     @relation(fields: [declaredById], references: [id])
  declaredAt       DateTime        @default(now())
  // Legacy field for backward compatibility with TrustedContact model
  trustedContactId String?
  trustedContact   TrustedContact? @relation(fields: [trustedContactId], references: [id])

  @@index([vaultId])
  @@index([declaredById])
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
}

model SecureFile {
  id           String   @id @default(uuid())
  ownerId      String
  filename     String
  mimeType     String
  size         Int
  storageKey   String   @unique
  encryptedKey String   // Base64 encoded DEK encrypted with master key
  iv           String   // Base64 encoded initialization vector
  authTag      String   // Base64 encoded authentication tag
  algorithm    String   @default("aes-256-gcm")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([ownerId])
}

// ==================================
// Beneficiary Account System
// ==================================

model BeneficiaryProfile {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  beneficiaries Beneficiary[]

  @@index([userId])
}

model BeneficiaryInvitation {
  id            String           @id @default(uuid())
  beneficiaryId String
  beneficiary   Beneficiary      @relation(fields: [beneficiaryId], references: [id], onDelete: Cascade)
  keepsakeId    String
  keepsake      Keepsake         @relation(fields: [keepsakeId], references: [id], onDelete: Cascade)
  token         String           @unique
  status        InvitationStatus @default(PENDING)
  sentAt        DateTime         @default(now())
  viewedAt      DateTime?
  acceptedAt    DateTime?
  expiresAt     DateTime
  resentBy      String?
  resentAt      DateTime?
  resentCount   Int              @default(0)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@index([token])
  @@index([beneficiaryId])
  @@index([keepsakeId])
  @@index([status])
}

enum InvitationStatus {
  PENDING
  VIEWED
  ACCEPTED
  EXPIRED
  CANCELLED
}

model BeneficiaryPortalAccess {
  id            String      @id @default(uuid())
  beneficiaryId String
  beneficiary   Beneficiary @relation(fields: [beneficiaryId], references: [id], onDelete: Cascade)
  keepsakeId    String?
  keepsake      Keepsake?   @relation(fields: [keepsakeId], references: [id], onDelete: Cascade)
  accessedAt    DateTime    @default(now())

  @@index([beneficiaryId])
  @@index([keepsakeId])
  @@index([accessedAt])
}

// ==================================
// Notification System
// ==================================

model NotificationConfig {
  id                      String   @id @default(uuid())
  vaultId                 String   @unique
  vault                   Vault    @relation(fields: [vaultId], references: [id], onDelete: Cascade)
  trustedPersonDelayHours Int      @default(72)
  beneficiaryDelayHours   Int      @default(168)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@index([vaultId])
}

model NotificationLog {
  id            String             @id @default(uuid())
  keepsakeId    String
  keepsake      Keepsake           @relation(fields: [keepsakeId], references: [id], onDelete: Cascade)
  beneficiaryId String?
  beneficiary   Beneficiary?       @relation(fields: [beneficiaryId], references: [id], onDelete: SetNull)
  type          NotificationType
  status        NotificationStatus @default(pending)
  scheduledFor  DateTime
  sentAt        DateTime?
  failureReason String?
  retryCount    Int                @default(0)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  @@index([keepsakeId])
  @@index([beneficiaryId])
  @@index([status, scheduledFor])
}

enum NotificationType {
  trusted_person_alert
  beneficiary_invitation
  account_creation
}

enum NotificationStatus {
  pending
  scheduled
  sent
  failed
  cancelled
}
